---
- hosts: product_rancher
  roles:
    - ansible-role-helm
    - ansible-role-cert-manager

- hosts: product_rancher
  roles:
    - ansible-role-rancher
    - ansible-role-local-path-provisioner

- hosts: product_rancher
  tasks:
    - name: patch ingress
      k8s:
        state: present
        definition: |
          apiVersion: extensions/v1beta1
          kind: Ingress
          metadata:
            name: rancher
            namespace: cattle-system
            annotations:
              certmanager.k8s.io/acme-challenge-type: dns01
              certmanager.k8s.io/acme-dns01-provider: cloudflare
              certmanager.k8s.io/cluster-issuer: letsencrypt-prod
          spec:
            tls:
            - hosts:
              - {{ rancher_helm_chart['values']['hostname'] }}
              secretName: rancher-tls-prod
